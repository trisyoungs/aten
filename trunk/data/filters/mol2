# Tripos (Sybyl) Mol2 filter
# Last modified: 05/08/08
# Notes:
#	Full spec is at: http://www.tripos.com/tripos_resources/fileroot/mol2_format_Dec07.pdf
# ChangeLog:
#	05/08/08 - Quoting adjusted to follow new Parser rules in r550.
#	30/06/08 - Changed extension list to only match 'mol2'

importmodel
	name "Tripos (Sybyl) Mol2"
	nickname mol2
	extension mol2
	glob *.mol2
	id 6

	# Variable declaration
	integer n,natoms,nbonds,id,ii,jj,spgrp,setting
	character tripos,keywd,e,bondtype
	double rx,ry,rz,ca,cb,cc,alpha,beta,gamma

	# Read in lines, looking for the sections we're interested in.
	# All sections begin with '@<TRIPOS>', e.g. '@<TRIPOS>MOLECULE'
	# Read a line and parse it into '@<TRIPOS>' and keyword parts
	for $n
		readline "$tripos%9 $keywd"
		if $keywd = "MOLECULE"
			# Molecule information
			getline $title
			newmodel $title
			readline "$natoms $nbonds"
			# Skip the next three lines, which are type of molecule, charges used XXX, and user comment
			skipline 4
		elseif $keywd = "ATOM"
			for $n,1,$natoms
				readline "$id $e $rx $ry $rz"
				newatom $e $rx $ry $rz
			end
		elseif $keywd = "BOND"
			for $n,1,$nbonds
				readline "* $ii $jj $bondtype"
				newbond $ii $jj $bondtype
			end
		elseif $keywd = "CRYSIN"
			# Crystal cell information
			# Single line, format is ' a b c alpha beta gamma spgrp spgrp_setting'
			readline "$ca $cb $cc $alpha $beta $gamma $spgrp $setting"
			cell $ca $cb $cc $alpha $beta $gamma
			spacegroup $spgrp
		end
	end

	# Perform post-load operations
	pack
	fold
	finalisemodel
end

