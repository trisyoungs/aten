# Siesta Flexible Data Format (fdf)
# Last modified: 14/12/2008
# ChangeLog:
#	14/12/2008 - Rearranged layout a little - cell writing still not implemented.
#	17/11/2008 - Fully working export filter.
#	07/11/2008 - First version.

#importmodel
#	name "Siesta FDF"
#	nickname fdf
#	extension fdf
#	glob *.fdf
#	id 9
#
#	# Variable declaration
#	integer natoms,n
#	character e,title
#	real rx,ry,rz,q
#
#	# Read data
#	readline "$natoms"
#	getline $title
#	newmodel $title
#	for $n,1,$natoms
#		readline "$e $rx $ry $rz $q"
#		newatom $e
#		setcoords $rx $ry $rz
#		setcharge $q
#	end
#	rebond
#	finalisemodel
#end

exportmodel
	name "Siesta FDF"
	nickname fdf
	extension fdf
	glob *.fdf
	id 9

	# Variable declaration
	integer n, el[130], nspecies
	character e
	real rx,ry,rz
	atom i

	# Determine number of species (elements) used in model, and create element->species map
	$el = 0
	$nspecies = 0
	for $i
		if $el[$i.z] = 0
			$nspecies += 1
			$el[$i.z] = $nspecies
		end
	end
	
	# Write title information
	writeline "SystemName  $model.name"
	writeline "SystemLabel $model.name"
	writeline "NumberOfAtoms $model.natoms"
	writeline "NumberOfSpecies  $nspecies"
	writeline ""

	# Write 'standard' keyword data
	writeline "PAO.EnergyShift      25 meV"
	writeline "MeshCutoff          400 Ry"
	writeline "DM.MixingWeight      0.4"
	writeline "NetCharge            1.0"
	writeline ""
	writeline "PAO.BasisSize       DZP"
	writeline "XC.functional       GGA"
	writeline "XC.authors          PBE"
	writeline "DM.NumberPulay      4"
	writeline "DM.Tolerance        1.d-6"
	writeline "SolutionMethod      diagon"
	writeline "MaxSCFIterations    100"
	writeline "ParallelOverK       true"
	writeline "MD.TypeOfRun        Verlet"
	writeline "MD.InitialTemperature  0.0  K"
	writeline "MD.InitialTimeStep    1"
	writeline "MD.FinalTimeStep    1"
	writeline "WriteCoorXmol       true"
	writeline "WriteForces         true"
	writeline ""

	# Write chemical species data, and label species in ascending order
	writeline "%block ChemicalSpeciesLabel"
	# 1  7    N-PBE 
	for $n,1,120
		if $el[$n] <> 0
			writeline "$el[$n]  $n  ${elements.symbol[$n]}-PBE"
		end
	end
	writeline "%endblock ChemicalSpeciesLabel"
	writeline ""

	# Write atomic coordinates
	writeline "AtomicCoordinatesFormat  Ang"
	writeline "%block AtomicCoordinatesAndAtomicSpecies"
	for $i
		writeline "$i.rx@14.8  $i.ry@14.8  $i.rz@14.8  $el[$i.z]"
	end
	writeline "%endblock AtomicCoordinatesAndAtomicSpecies"
	writeline ""

end
