# GAMESS-US Trajectory Filter, and Cartesian Input Model Filters (I/O)
# Protein databank coordinates import (for v1.1+)
# Created:	 14/04/2009
# Last modified: 14/04/2009
# ChangeLog:
# Notes:
#	Output model filter sets symmetry to C1, regardless of the actual symmetry.

filter(type="importmodel", name="GAMESS-US Log File", nickname="gamuslog", extension="log", glob="*.log", zmap="name", search="GAMESS VERSION")
{
	# Variable declaration
	int result,nstructures,natoms,n;
	string line,e,name,discard;
	double rx,ry,rz;

	# Determine number of atoms - search for line containing 'TOTAL NUMBER OF ATOMS'
	if (!find("TOTAL NUMBER OF ATOMS",line)) error("Couldn't determine number of atoms from GAMESS-US output.");

	# Get number of atoms from line
	readvarf(line, "%48*%i",natoms);

	# Create a new model, and store its pointer for use later
	model m = newmodel("GAMESS-US Output");

	# Now search for sets of coordinate
	nstructures = 0;
	while (!eof())
	{
		# Lines containing 'COORDINATES OF ALL ATOMS ARE' are the beginning of coordinate sections
		if (find("COORDINATES OF ALL ATOMS ARE"))
		{
			printf("Found a configuration...\n");
			# Found a set of coordinates. Skip 2 lines and then read coordinates
			nstructures++;
			skipline(2);
			writevarf(name, "Frame %i", nstructures);
			addframe(name);
			for (n=1; n<=natoms; ++n)
			{
				readline(e,discard,rx,ry,rz);
				newatom(e,rx,ry,rz);
			}
			# Recalculate bonding
			rebond();
			finaliseframe();
		}
	}

	# Now, copy the contents of the current (i.e. last) frame, and paste it into the parent model
	selectall();
	copy();
	getmodel(m);
	paste();
	finalisemodel();
}

#importmodel
#	name "GAMESS-US Cartesian Input"
#	extension inp
#	glob *.inp
#	nickname gamusinp
#	id 5
#	zmap name
#
#	# Variables
#	character symm,tester,symbol,title
#	integer n,z
#	real rx,ry,rz
#
#	# Search for $DATA section
#	find "DATA" $n
#	if $n = 0
#		error "Couldn't find 'DATA' section in input file."
#	end
#
#	# Read in title card
#	getline $title
#	newmodel $title
#
#	# Skip over symmetry specification
#	readline "$symm"
#	if $symm <> C1
#		# Single blank line means the master frame is in use, and only this line to skip
#		readline "$tester"
#		if $tester <> ""
#			skipline
#		end
#	end
#	
#	# Coordinates follow, terminated by $END
#	for $n
#		readline "$symbol $z $rx $ry $rz
#		if $symbol = "$END"
#			break
#		end
#		newatom $symbol $rx $ry $rz
#	end
#
#	# Done
#	rebond
#	finalisemodel
#end
#
#exportmodel
#	name "GAMESS-US Cartesian Input"
#	extension inp
#	glob *.inp
#	nickname gamusinp
#	id 5
#
#	# Variable declarations
#	atom i
#
#	# Write a standard control header
#	writeline " \$SYSTEM MEMDDI=16 \$END"
#	writeline " \$CONTRL SCFTYP=RHF RUNTYP=OPTIMIZE COORD=CART ICHARG=0 MULT=1 \$END"
#	writeline " \$STATPT NSTEP=100 \$END"
#	writeline " \$SYSTEM TIMLIM=1200 MWORDS=96 \$END"
#	writeline " \$BASIS GBASIS=N31 NGAUSS=6 NDFUNC=1 \$END"
#	writeline " \$GUESS GUESS=HUCKEL \$END"
#	writeline " \$SCF DIRSCF=.TRUE. \$END"
#
#	# Now for the DATA section
#	writeline " \$DATA"
#	writeline "$model.name"
#	writeline "C1"
#	for $i
#		writeline "$i.name@10  $i.z@4 $i.rx@12.6 $i.ry@12.6 $i.rz@12.6"
#	end
#	writeline " \$END"
#end
